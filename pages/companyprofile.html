<!-- Author: Angirmaa Ganbat x24177032 -->
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet">
    <link href='https://fonts.googleapis.com/css?family=Roboto' rel='stylesheet'>
  <title>Company profile</title>
  <style>
    h2 {
    clear: both;
    font-size: 1.8em;
    margin-bottom: 10px;
    padding: 10px 0 10px 30px;
}

h3 > span {
    border-bottom: 2px solid #C2C2C2;
    display: inline-block;
    padding: 0 5px 5px;
}
.CompanyInformation .userName{
      font-size: 45px !important; 
      font-family:'Roboto', sans-serif !important; 
      color: #281B55 !important;
}
  </style>
  </head>
  <body class="body">
    <nav class="navbar navbar-expand-lg bg-body-tertiary">
      <div class="container-fluid">
        <!-- Logo image-->
        <a class="navbar-brand" href="home.html">
          <img src="../imgs/logo.png" alt="Logo" width="150">
        </a>

       
      </div>
    </nav>
<!-- main part starts-->
     
        <section class="vh-100" style="background-color: #EDF0F5;">
          <div class="container py-5 h-150" >
            <div class="row d-flex justify-content-center align-items-center h-100">
              <div class="col col-xl-12">
                    <div class="card mb-5" style="border-radius: 15px; min-height: 300px;">

                      <div class="card-body p-4" id = "CompanyInfo">
                        
                      </div>    

                            <!--  Table-->
                          <div class="table-responsive" id = "postLikeInfo">
                             
                       <!--  Table finishes-->
                      </div>
                    
                </div>
              </div>
            </div>
        </section>

<!-- main part finishes-->


    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
      //selecting all the user information 
       async function getComProfileInfo() {
      const CompanyInformation = document.getElementById("CompanyInfo")
      const token = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");
      
      
  try {
    const response = await fetch(`http://localhost:8086/api/v1/users/${userId}`, {
     //fetch the user information by userId
      headers: {
        "Authorization": `Bearer ${token}`
        //checking the token
      }
    });
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
      //if the response not ok there will an error message  
    }

    const result = await response.json();
    const newDiv = document.createElement("div");
    //if it gets the information, it will put them in the new div 
    let fileHtml="";
    newDiv.innerHTML = 
      `<h3 class="mb-3 userName" style="font-size: 25px; font-family: 'Roboto', sans-serif; color: navy;">${result.userName}</h3>
      <p class="small mb-3" style="font-size: 18px; font-family: 'Roboto', sans-serif; ">Email: ${result.email}</p>
      <p class="small mb-3" style="font-size: 18px; font-family: 'Roboto', sans-serif; ">Status: ${result.status}</p> 
      `;
      
       CompanyInformation.prepend(newDiv);
     
    console.log(result);
  } catch (error) {
    console.error("Fetch error:", error);
  }
}
    </script>
    

     <script>
      
      async function getInfoPostLike() {
      const postLikeInfo = document.getElementById("postLikeInfo")
      const token = localStorage.getItem("token");
      const userId = localStorage.getItem("userId");
      //Getting the elements and user id and token from loacl storage
      
  try {
    const response = await fetch(`http://localhost:8086/api/v1/posts`, {
     
      headers: {
        "Authorization": `Bearer ${token}`
      }
      //requesting to get all post 
    });
    if (!response.ok) {
      throw new Error(`Response status: ${response.status}`);
      //if there is error, it will show the error status 
    }
    //NOTE: 
      //TO code the most liked post, I got some help from openAI chatGPT /only this part/
    const result = await response.json();
    const companyPosts = result;
    //it will wait the json result 
    const allTags = companyPosts.map(posts => {
    const tag = posts.postText.match(/@\w+/g);
    return tag ? tag[0]:null;
    // here it's mapping the all post 
    //and taking the only posts that has tag
    //if there is any tag post it will return those post 
    //or it will return null

    })
    .filter(Boolean);
    const uniqueTags=[...new Set (allTags)];
    const tags = uniqueTags.slice(-10);
    //it it's taking the unique first 10 tag campaign, promotion name 
  
    let tableRows = "";
    tags.forEach((tag, index)=>{
      const userPosts = companyPosts.filter(post =>
        post.status==="user"&&post.postText.includes(tag)
        //here the table row goes for each tag name
      );

    if(userPosts.length>0){
      userPosts.sort((a,b)=>b.likesAmount - a.likesAmount);
      //from the tags it'll choose the most liked one post 
      const winner = userPosts[0];
      //here the table rows goest down including tag name, 
      //user name, and like amount 
      tableRows+=`
        <tr>
          <th scope="row" >${index + 1}</th>
          <th scope="col" style="font-size: 18px; font-family: 'Roboto', sans-serif; ">${tag}</th>
          <th scope="col" style="font-size: 18px; font-family: 'Roboto', sans-serif; ">${winner.userName}</th>
          <th scope="col" style="font-size: 18px; font-family: 'Roboto', sans-serif; ">${winner.likesAmount}</th>
          </tr>`

    }else{
      tableRows+=`
        <tr>
          <th scope="row">${index + 1}</th>
          <th scope="col">${tag}</th>
          <th scope="col">0</th>
          <th scope="col">0</th>
          </tr>`

    }
});

    const newDiv = document.createElement("div");
    newDiv.innerHTML = 
      `
        <table class="table">
          <thead>
            <tr>
              <th scope="col" ></th>
              <th scope="col" style="font-size: 19px; font-family: 'Roboto', sans-serif; color: navy;" >Compaign name</th>
              <th scope="col" style="font-size: 19px; font-family: 'Roboto', sans-serif; color: navy;" >Winner name</th> 
              <th scope="col" style="font-size: 19px; font-family: 'Roboto', sans-serif; color: navy;" >Like amount</th>                           
            </tr>
          </thead>
          <tbody>
            ${tableRows}
          </tbody>

        </table>

      `;
      
       postLikeInfo.prepend(newDiv);
     
    console.log(result);
  } catch (error) {
    console.error("Fetch error:", error);
  }
}
    </script>
    <script>
      //here this window will load getting profile info and post like info 
      window.onload=function(){
      getComProfileInfo()
      getInfoPostLike()
    }
    </script>


    <script>
    const logOutButton = document.querySelector('.logOut');
    // selecting the log out by querySelector 
    logOutButton.addEventListener('click', event => {
      event.preventDefault();
      //using eventlistener to perform the log out button 
      const token = localStorage.getItem("token");

      fetch('http://localhost:8086/api/v1/auth/logOut', {
        //here it will fetch the log out request 
        method: 'POST', 
        headers: {
          'Content-Type': 'application/json',
          "Authorization": `Bearer ${token}`

        }, 
        //checking this with the token 
      }).then(response => {
        if(response.ok) {
          localStorage.removeItem('token');
          localStorage.removeItem('userId');
           window.location.href = "../index.html"
           //if the response ok, local storage remove the token then 
           //it will load the index.html window 
        }else{
          alert("Log out failed!");
          //if the request failed there will be alert message request failed
        }
      })
        .catch(error => alert("network error!"));
      });
  </script>
 

  </body>
</html>

